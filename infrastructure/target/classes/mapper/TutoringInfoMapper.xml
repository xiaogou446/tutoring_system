<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lin.webtemplate.infrastructure.mapper.TutoringInfoMapper">

    <resultMap id="TutoringInfoResultMap" type="com.lin.webtemplate.infrastructure.entity.TutoringInfoEntity">
        <id property="id" column="id"/>
        <result property="sourceUrl" column="source_url"/>
        <result property="title" column="title"/>
        <result property="publishTime" column="publish_time"/>
        <result property="contentText" column="content_text"/>
        <result property="district" column="district"/>
        <result property="grade" column="grade"/>
        <result property="subject" column="subject"/>
        <result property="salary" column="salary"/>
        <result property="teacherGender" column="teacher_gender"/>
        <result property="contact" column="contact"/>
        <result property="parsedAt" column="parsed_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <sql id="FilterSql">
        <if test="condition.keyword != null and condition.keyword != ''">
            AND (title LIKE CONCAT('%', #{condition.keyword}, '%')
                OR content_text LIKE CONCAT('%', #{condition.keyword}, '%')
                OR subject LIKE CONCAT('%', #{condition.keyword}, '%')
                OR grade LIKE CONCAT('%', #{condition.keyword}, '%')
                OR district LIKE CONCAT('%', #{condition.keyword}, '%'))
        </if>
        <if test="condition.district != null and condition.district != ''">
            AND district = #{condition.district}
        </if>
        <if test="condition.grade != null and condition.grade != ''">
            AND grade = #{condition.grade}
        </if>
        <if test="condition.subject != null and condition.subject != ''">
            AND subject = #{condition.subject}
        </if>
    </sql>

    <insert id="upsert" parameterType="com.lin.webtemplate.infrastructure.entity.TutoringInfoEntity">
        MERGE INTO tutoring_info
            (id, source_url, title, publish_time, content_text, district, grade, subject, salary, teacher_gender, contact, parsed_at, created_at, updated_at)
        KEY(id)
        VALUES
            (#{id}, #{sourceUrl}, #{title}, #{publishTime}, #{contentText}, #{district}, #{grade}, #{subject}, #{salary}, #{teacherGender}, #{contact}, #{parsedAt}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    </insert>

    <select id="findById" resultMap="TutoringInfoResultMap">
        SELECT id,
               source_url,
               title,
               publish_time,
               content_text,
               district,
               grade,
               subject,
               salary,
               teacher_gender,
               contact,
               parsed_at,
               created_at,
               updated_at
        FROM tutoring_info
        WHERE id = #{id}
    </select>

    <select id="queryPage" resultMap="TutoringInfoResultMap">
        SELECT id,
               source_url,
               title,
               publish_time,
               content_text,
               district,
               grade,
               subject,
               salary,
               teacher_gender,
               contact,
               parsed_at,
               created_at,
               updated_at
        FROM tutoring_info
        WHERE 1 = 1
        <include refid="FilterSql"/>
        <choose>
            <when test="condition.sort == 'salary_high'">
                ORDER BY CASE
                             WHEN NULLIF(REGEXP_REPLACE(COALESCE(salary, ''), '[^0-9]', ''), '') IS NULL THEN 1
                             ELSE 0
                         END ASC,
                         CAST(NULLIF(REGEXP_REPLACE(COALESCE(salary, ''), '[^0-9]', ''), '') AS BIGINT) DESC,
                         publish_time DESC,
                         id DESC
            </when>
            <when test="condition.sort == 'salary_low'">
                ORDER BY CASE
                             WHEN NULLIF(REGEXP_REPLACE(COALESCE(salary, ''), '[^0-9]', ''), '') IS NULL THEN 1
                             ELSE 0
                         END ASC,
                         CAST(NULLIF(REGEXP_REPLACE(COALESCE(salary, ''), '[^0-9]', ''), '') AS BIGINT) ASC,
                         publish_time DESC,
                         id DESC
            </when>
            <otherwise>
                ORDER BY publish_time DESC, id DESC
            </otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="count" resultType="long">
        SELECT COUNT(1)
        FROM tutoring_info
        WHERE 1 = 1
        <include refid="FilterSql"/>
    </select>
</mapper>
