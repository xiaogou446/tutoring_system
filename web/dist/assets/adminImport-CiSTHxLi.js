import{k as Z,l as ee,m as te,o as n,c as i,a as e,t as a,f as c,b as y,v as b,p as se,F as P,e as U,d as N,n as z,h as x,r as p,i as j,j as le}from"./runtime-dom.esm-bundler-B9a5nMVl.js";const ae={class:"admin-page"},oe={class:"admin-head"},ne={key:0,class:"user-chip"},ie={class:"user-name"},re={key:0,class:"panel loading-panel"},ue={key:1,class:"console-layout login-layout"},de={class:"panel main-panel"},ce={class:"field"},pe={class:"field"},me={key:0,class:"error-tip"},ve={class:"actions one-col"},fe=["disabled"],ye={key:2,class:"console-layout shell-layout"},ge={class:"panel nav-shell"},he=["onClick"],ke={class:"nav-title"},be={class:"nav-desc"},_e={key:0,class:"panel main-panel"},we={class:"status"},Ce={class:"import-grid"},Te={class:"field"},Ie=["disabled"],Ee=["value"],Re={class:"field"},Le={class:"hint"},Pe={class:"actions"},Ue=["disabled"],Oe=["disabled"],$e=["disabled"],xe={class:"panel nested-panel"},Se={key:0,class:"result-grid"},Ve={class:"metric-card"},Ne={class:"metric-value"},je={class:"metric-card"},Fe={class:"metric-value"},Ae={class:"metric-card"},De={class:"metric-value"},Me={key:1,class:"task-list"},Je={class:"task-tags"},Be={key:2,class:"task-list progress-wrap"},Ke={class:"progress-head"},We={key:0,class:"hint"},qe={key:1,class:"error-tip"},ze={key:2,class:"result-grid"},Ge={class:"metric-card"},He={class:"metric-value"},Qe={class:"metric-card"},Xe={class:"metric-value"},Ye={class:"metric-card"},Ze={class:"metric-value"},et={key:3,class:"progress-items"},tt={class:"progress-line"},st={class:"task-tag"},lt={key:0,class:"hint"},at={key:3,class:"notice"},ot={key:1,class:"panel main-panel"},nt={class:"log-filter-grid"},it={class:"field"},rt={class:"field"},ut={class:"field"},dt={class:"field"},ct={class:"field"},pt={class:"field"},mt={class:"actions two-col"},vt=["disabled"],ft=["disabled"],yt={key:0,class:"error-tip"},gt={key:1,class:"task-list"},ht={class:"task-title"},kt={class:"runtime-log-list"},bt={class:"runtime-log-head"},_t={class:"task-tag"},wt={class:"runtime-meta"},Ct={class:"runtime-log-message"},Tt=3e3,It={__name:"AdminImportApp",setup(Et){const G=[{key:"import",title:"导入中心",desc:"批量 URL 导入与受理反馈"},{key:"logs",title:"运行日志",desc:"统一查看 Java/Python 运行日志"}],O=p("import"),o=x({checking:!0,authenticated:!1,userId:null,username:"",loggingIn:!1,loginError:""}),h=x({username:"admin",password:""}),f=x({platformCode:"",urlsText:""}),k=p([]),E=p(!1),R=p(!1),u=p("请先登录后台，再选择平台并粘贴 URL（每行一个）"),d=p(null),S=p(!1),_=p(""),v=p(null),$=p(0),r=x({runtime:"java",level:"",keyword:"",startTime:"",endTime:"",limit:50}),L=p(!1),w=p(""),C=p(null),F=j(()=>f.urlsText.split(/\r?\n/).map(l=>l.trim()).filter(l=>l!=="")),A=j(()=>F.value.length),D=j(()=>{var l;return!!((l=v.value)!=null&&l.allFinished)});function M(){_.value="",v.value=null,T()}function T(){$.value&&(window.clearInterval($.value),$.value=0)}function H(){f.urlsText="",d.value=null,M(),u.value="已清空输入，可重新粘贴 URL 列表"}async function I(l){const t=await l.json();if(!l.ok||!(t!=null&&t.success))throw new Error((t==null?void 0:t.message)||"请求失败，请稍后重试");return t.data}async function J(){var l,t;if((t=(l=d.value)==null?void 0:l.taskIds)!=null&&t.length){S.value=!0,_.value="";try{const g=await fetch("/admin/import/tasks/progress",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({taskIds:d.value.taskIds})});v.value=await I(g);const m=v.value;u.value=`执行进度：${m.finishedCount}/${m.totalCount}（成功 ${m.successCount}，失败 ${m.failedCount}）`,m.allFinished&&T()}catch(g){_.value=g.message,u.value=`进度查询失败：${g.message}`,T()}finally{S.value=!1}}}function Q(){T(),J(),$.value=window.setInterval(()=>{J()},Tt)}async function B(){o.checking=!0,o.loginError="";try{const l=await fetch("/admin/auth/profile",{credentials:"include"}),t=await I(l);o.authenticated=!0,o.userId=t.userId,o.username=t.username,u.value=`登录状态已确认，当前管理员：${t.username}`}catch{o.authenticated=!1,o.userId=null,o.username="",u.value="未登录，请先完成后台登录"}finally{o.checking=!1}}async function K(){o.loggingIn=!0,o.loginError="";try{const l=await fetch("/admin/auth/login",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:h.username,password:h.password})});await I(l),h.password="",await B(),await V()}catch(l){o.loginError=l.message,u.value=`登录失败：${l.message}`}finally{o.loggingIn=!1}}async function X(){try{await fetch("/admin/auth/logout",{method:"POST",credentials:"include"})}finally{T(),o.authenticated=!1,o.userId=null,o.username="",k.value=[],f.platformCode="",d.value=null,v.value=null,_.value="",C.value=null,w.value="",u.value="已退出登录"}}async function V(){if(!o.authenticated){u.value="请先登录后再加载平台列表";return}E.value=!0;try{const l=await fetch("/admin/import/platform-options",{credentials:"include"}),t=await I(l);k.value=t||[],!f.platformCode&&k.value.length>0&&(f.platformCode=k.value[0].platformCode),u.value=`平台加载成功：${k.value.length} 个可用平台`}catch(l){k.value=[],u.value=`平台加载失败：${l.message}`}finally{E.value=!1}}async function W(){if(!o.authenticated){w.value="请先登录后再查询运行日志";return}L.value=!0,w.value="";try{const l={runtime:r.runtime,level:r.level||void 0,keyword:r.keyword||void 0,startTime:r.startTime||void 0,endTime:r.endTime||void 0,limit:r.limit},t=await fetch("/admin/runtime-logs/query",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});C.value=await I(t)}catch(l){w.value=l.message}finally{L.value=!1}}async function Y(){var l;if(!o.authenticated){u.value="请先登录后再提交导入任务";return}R.value=!0,d.value=null,M();try{const t={platformCode:f.platformCode,urls:F.value},g=await fetch("/admin/import/tasks",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),m=await I(g);d.value=m,u.value=`受理成功：共 ${m.acceptedCount} 条任务已入队`,(l=m.taskIds)!=null&&l.length&&Q()}catch(t){u.value=`提交失败：${t.message}`}finally{R.value=!1}}return Z(()=>{B().then(()=>{o.authenticated&&V()})}),ee(O,l=>{l==="logs"&&o.authenticated&&W()}),te(()=>{T()}),(l,t)=>{var g,m;return n(),i("main",ae,[e("header",oe,[t[12]||(t[12]=e("div",null,[e("p",{class:"eyebrow"},"Tutor Admin System"),e("h1",{class:"title"},"家教后台管理系统"),e("p",{class:"desc"},"统一登录、导入、日志的后台工作台（白色系专业控制台）")],-1)),o.authenticated?(n(),i("div",ne,[t[11]||(t[11]=e("span",{class:"user-tag"},"在线",-1)),e("span",ie,a(o.username)+"（#"+a(o.userId)+"）",1),e("button",{class:"btn mini",type:"button",onClick:X},"退出登录")])):c("",!0)]),o.checking?(n(),i("section",re,[...t[13]||(t[13]=[e("p",{class:"panel-title"},"正在校验登录态...",-1),e("p",{class:"status"},"请稍候，系统正在确认后台会话。",-1)])])):o.authenticated?(n(),i("section",ye,[e("aside",ge,[t[19]||(t[19]=e("p",{class:"nav-head"},"功能导航",-1)),(n(),i(P,null,U(G,s=>e("button",{key:s.key,class:z(["nav-item",{active:O.value===s.key}]),type:"button",onClick:q=>O.value=s.key},[e("span",ke,a(s.title),1),e("span",be,a(s.desc),1)],10,he)),64))]),O.value==="import"?(n(),i("section",_e,[t[32]||(t[32]=e("h2",{class:"panel-title"},"导入中心",-1)),e("p",we,a(u.value),1),e("div",Ce,[e("div",null,[e("div",Te,[t[20]||(t[20]=e("label",{for:"platform",class:"label"},"平台选择",-1)),y(e("select",{id:"platform","onUpdate:modelValue":t[2]||(t[2]=s=>f.platformCode=s),disabled:E.value||!k.value.length},[(n(!0),i(P,null,U(k.value,s=>(n(),i("option",{key:s.platformCode,value:s.platformCode},a(s.platformName)+"（"+a(s.platformCode)+"） ",9,Ee))),128))],8,Ie),[[N,f.platformCode]])]),e("div",Re,[t[21]||(t[21]=e("label",{for:"urls",class:"label"},"URL 列表（每行一个）",-1)),y(e("textarea",{id:"urls","onUpdate:modelValue":t[3]||(t[3]=s=>f.urlsText=s),placeholder:`https://example.com/a
https://example.com/b`,rows:"10"},null,512),[[b,f.urlsText]]),e("p",Le,"当前预览 "+a(A.value)+" 条，超出 10 条会被拒绝。",1)]),e("div",Pe,[e("button",{class:"btn primary",type:"button",disabled:R.value||A.value===0,onClick:Y},a(R.value?"正在受理...":"提交导入任务"),9,Ue),e("button",{class:"btn ghost",type:"button",disabled:E.value,onClick:V},a(E.value?"刷新中...":"刷新平台列表"),9,Oe),e("button",{class:"btn ghost",type:"button",disabled:R.value,onClick:H},"清空输入",8,$e)])]),e("div",xe,[t[31]||(t[31]=e("h3",{class:"sub-title"},"受理反馈",-1)),d.value?(n(),i("div",Se,[e("article",Ve,[t[22]||(t[22]=e("p",{class:"metric-title"},"提交条数",-1)),e("p",Ne,a(d.value.submittedCount),1)]),e("article",je,[t[23]||(t[23]=e("p",{class:"metric-title"},"受理条数",-1)),e("p",Fe,a(d.value.acceptedCount),1)]),e("article",Ae,[t[24]||(t[24]=e("p",{class:"metric-title"},"去重条数",-1)),e("p",De,a(d.value.deduplicatedCount),1)])])):c("",!0),d.value?(n(),i("div",Me,[t[25]||(t[25]=e("p",{class:"task-title"},"受理任务 ID",-1)),e("div",Je,[(n(!0),i(P,null,U(d.value.taskIds,s=>(n(),i("span",{key:s,class:"task-tag"},"#"+a(s),1))),128))])])):c("",!0),d.value?(n(),i("div",Be,[e("div",Ke,[t[26]||(t[26]=e("p",{class:"task-title"},"导入进度",-1)),e("span",{class:z(["progress-state",{done:D.value}])},a(D.value?"已完成":"进行中"),3)]),S.value?(n(),i("p",We,"正在刷新任务进度...")):c("",!0),_.value?(n(),i("p",qe,a(_.value),1)):c("",!0),v.value?(n(),i("div",ze,[e("article",Ge,[t[27]||(t[27]=e("p",{class:"metric-title"},"总任务",-1)),e("p",He,a(v.value.totalCount),1)]),e("article",Qe,[t[28]||(t[28]=e("p",{class:"metric-title"},"已完成",-1)),e("p",Xe,a(v.value.finishedCount),1)]),e("article",Ye,[t[29]||(t[29]=e("p",{class:"metric-title"},"失败数",-1)),e("p",Ze,a(v.value.failedCount),1)])])):c("",!0),(m=(g=v.value)==null?void 0:g.items)!=null&&m.length?(n(),i("div",et,[(n(!0),i(P,null,U(v.value.items,s=>(n(),i("article",{key:s.taskId,class:"progress-item"},[e("p",tt,[e("span",st,"#"+a(s.taskId),1),e("span",null,a(s.status),1)]),s.latestErrorType||s.latestErrorMessage?(n(),i("p",lt,a(s.latestErrorType||"DETAIL")+"："+a(s.latestErrorMessage||"无"),1)):c("",!0)]))),128))])):c("",!0)])):c("",!0),d.value?c("",!0):(n(),i("div",at,[...t[30]||(t[30]=[e("p",null,"说明：",-1),e("p",null,"1) 接口走 Cookie 鉴权，登录态失效时请重新登录。",-1),e("p",null,"2) 同一请求内 URL 自动去重，并回传去重统计。",-1),e("p",null,"3) 导入受理后异步执行，可在日志中心追踪任务。",-1)])]))])])])):(n(),i("section",ot,[t[41]||(t[41]=e("h2",{class:"panel-title"},"运行日志中心",-1)),t[42]||(t[42]=e("p",{class:"status"},"支持 runtime/级别/关键字/时间范围筛选（仅在线查看，不提供下载）。",-1)),e("div",nt,[e("div",it,[t[34]||(t[34]=e("label",{for:"runtime",class:"label"},"运行端",-1)),y(e("select",{id:"runtime","onUpdate:modelValue":t[4]||(t[4]=s=>r.runtime=s)},[...t[33]||(t[33]=[e("option",{value:"java"},"java",-1),e("option",{value:"python"},"python",-1)])],512),[[N,r.runtime]])]),e("div",rt,[t[36]||(t[36]=e("label",{for:"level",class:"label"},"级别",-1)),y(e("select",{id:"level","onUpdate:modelValue":t[5]||(t[5]=s=>r.level=s)},[...t[35]||(t[35]=[e("option",{value:""},"全部",-1),e("option",{value:"INFO"},"INFO",-1),e("option",{value:"WARN"},"WARN",-1),e("option",{value:"ERROR"},"ERROR",-1)])],512),[[N,r.level]])]),e("div",ut,[t[37]||(t[37]=e("label",{for:"keyword",class:"label"},"关键字",-1)),y(e("input",{id:"keyword","onUpdate:modelValue":t[6]||(t[6]=s=>r.keyword=s),type:"text",placeholder:"例如：timeout / keyword-hit"},null,512),[[b,r.keyword]])]),e("div",dt,[t[38]||(t[38]=e("label",{for:"startTime",class:"label"},"开始时间",-1)),y(e("input",{id:"startTime","onUpdate:modelValue":t[7]||(t[7]=s=>r.startTime=s),type:"datetime-local"},null,512),[[b,r.startTime]])]),e("div",ct,[t[39]||(t[39]=e("label",{for:"endTime",class:"label"},"结束时间",-1)),y(e("input",{id:"endTime","onUpdate:modelValue":t[8]||(t[8]=s=>r.endTime=s),type:"datetime-local"},null,512),[[b,r.endTime]])]),e("div",pt,[t[40]||(t[40]=e("label",{for:"limit",class:"label"},"返回条数",-1)),y(e("input",{id:"limit","onUpdate:modelValue":t[9]||(t[9]=s=>r.limit=s),type:"number",min:"1",max:"200"},null,512),[[b,r.limit,void 0,{number:!0}]])])]),e("div",mt,[e("button",{class:"btn primary",type:"button",disabled:L.value,onClick:W},a(L.value?"查询中...":"查询日志"),9,vt),e("button",{class:"btn ghost",type:"button",disabled:L.value,onClick:t[10]||(t[10]=s=>r.keyword="")}," 清空关键字 ",8,ft)]),w.value?(n(),i("p",yt,a(w.value),1)):c("",!0),C.value?(n(),i("div",gt,[e("p",ht,"查询结果："+a(C.value.runtime)+" / "+a(C.value.totalCount)+" 条",1),e("div",kt,[(n(!0),i(P,null,U(C.value.items,(s,q)=>(n(),i("article",{key:`${s.timestamp}-${q}`,class:"runtime-log-item"},[e("p",bt,[e("span",_t,a(s.level),1),e("span",wt,a(s.timestamp),1)]),e("p",Ct,a(s.message),1)]))),128))])])):c("",!0)]))])):(n(),i("section",ue,[t[18]||(t[18]=e("aside",{class:"panel nav-shell"},[e("p",{class:"nav-head"},"功能导航"),e("button",{class:"nav-item active",type:"button"},"导入中心"),e("button",{class:"nav-item",type:"button",disabled:""},"运行日志")],-1)),e("section",de,[t[16]||(t[16]=e("h2",{class:"panel-title"},"后台登录",-1)),t[17]||(t[17]=e("p",{class:"status"},"请输入管理员账号密码，登录后进入「家教后台管理系统」。",-1)),e("div",ce,[t[14]||(t[14]=e("label",{for:"username",class:"label"},"用户名",-1)),y(e("input",{id:"username","onUpdate:modelValue":t[0]||(t[0]=s=>h.username=s),type:"text",autocomplete:"username"},null,512),[[b,h.username]])]),e("div",pe,[t[15]||(t[15]=e("label",{for:"password",class:"label"},"密码",-1)),y(e("input",{id:"password","onUpdate:modelValue":t[1]||(t[1]=s=>h.password=s),type:"password",autocomplete:"current-password",onKeyup:se(K,["enter"])},null,544),[[b,h.password]])]),o.loginError?(n(),i("p",me,a(o.loginError),1)):c("",!0),e("div",ve,[e("button",{class:"btn primary",type:"button",disabled:o.loggingIn||!h.password,onClick:K},a(o.loggingIn?"登录中...":"登录并进入系统"),9,fe)])])]))])}}};le(It).mount("#app");
