<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lin.webtemplate.infrastructure.mapper.CrawlTaskLogMapper">

    <resultMap id="CrawlTaskLogResultMap" type="com.lin.webtemplate.infrastructure.dataobject.CrawlTaskLogDO">
        <id column="id" property="id"/>
        <result column="task_id" property="taskId"/>
        <result column="runtime" property="runtime"/>
        <result column="stage" property="stage"/>
        <result column="status" property="status"/>
        <result column="error_type" property="errorType"/>
        <result column="error_summary" property="errorSummary"/>
        <result column="error_message" property="errorMessage"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <insert id="insert" parameterType="com.lin.webtemplate.infrastructure.dataobject.CrawlTaskLogDO"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO crawl_task_log(task_id, runtime, stage, status, error_type, error_summary, error_message, created_at)
        VALUES (#{taskId}, #{runtime}, #{stage}, #{status}, #{errorType}, #{errorSummary}, #{errorMessage}, CURRENT_TIMESTAMP)
    </insert>

    <select id="selectLatestByTaskIds" resultMap="CrawlTaskLogResultMap">
        SELECT l.id,
               l.task_id,
               l.runtime,
               l.stage,
               l.status,
               l.error_type,
               l.error_summary,
               l.error_message,
               l.created_at
          FROM crawl_task_log l
          JOIN (
                SELECT task_id,
                       MAX(id) AS max_id
                  FROM crawl_task_log
                 WHERE task_id IN
                <foreach collection="taskIds" item="taskId" open="(" separator="," close=")">
                    #{taskId}
                </foreach>
                 GROUP BY task_id
          ) latest
            ON l.task_id = latest.task_id
           AND l.id = latest.max_id
    </select>

    <select id="selectForRuntimeLog" resultMap="CrawlTaskLogResultMap">
        SELECT id,
               task_id,
               runtime,
               stage,
               status,
               error_type,
               error_summary,
               error_message,
               created_at
          FROM crawl_task_log
        <where>
            <if test="startTime != null">
                AND created_at <![CDATA[>=]]> #{startTime}
            </if>
            <if test="endTime != null">
                AND created_at <![CDATA[<=]]> #{endTime}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                    stage LIKE CONCAT('%', #{keyword}, '%')
                    OR status LIKE CONCAT('%', #{keyword}, '%')
                    OR error_type LIKE CONCAT('%', #{keyword}, '%')
                    OR error_summary LIKE CONCAT('%', #{keyword}, '%')
                    OR error_message LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
         ORDER BY created_at DESC, id DESC
         LIMIT #{limit}
    </select>

</mapper>
