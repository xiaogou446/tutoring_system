## Context

当前系统已具备单平台采集、解析、入库与前台检索能力，但采集规则仍按固定来源耦合实现，难以平滑扩展到新平台。与此同时，手动导入主要依赖 CLI，缺少可运营的后台入口；运行日志分散在 Java 与 Python 进程侧，排障效率有限。

本次设计涉及 Java 多模块后端、Python crawler 与 web 前端协同改造，约束条件如下：
- 不破坏现有 `tutoring_info` 产出契约与查询接口。
- 平台差异在 `article_raw` 层完成归一化，后续链路尽量复用。
- 后台登录仅支持 DB 预置管理员，不引入注册流程。
- 日志展示优先满足“可查、可筛、可追踪”，不做复杂日志平台替代。

## Goals / Non-Goals

**Goals:**
- 建立平台主数据与平台编码贯穿链路（采集 -> 解析 -> 原文入库）。
- 让 `article_raw` 支持按平台路由解析并统一产出规范化 `content_text`。
- 新增后台管理最小闭环：管理员登录、页面化导入、运行日志查看。
- 保持 `tutoring_info` 的生成流程与下游查询契约稳定。

**Non-Goals:**
- 不在本期改造 `tutoring_info` 字段模型与检索接口。
- 不引入第三方日志平台（如 ELK/Loki）或消息队列。
- 不实现后台账号注册、找回密码、多租户权限模型。
- 不实现平台规则的可视化编排器（本期采用代码路由与配置）。

## Decisions

### 决策 1：引入平台主数据表并以 platformCode 贯穿全链路
- 选择：新增平台表（如 `crawl_platform`），维护 `platform_code`、`platform_name`、`status`、`description`；`article_raw` 与任务模型新增 `platform_code` 字段。
- 原因：把“平台类型”从代码常量提升为可管理主数据，便于后续扩平台与后台下拉选择。
- 备选方案：仅在代码中写死枚举。放弃原因是扩展和运维成本高，后台无法感知可选平台。

### 决策 2：采用“平台路由解析器”统一生成 article_raw.content_text
- 选择：在 crawler 解析入口增加 `platformCode -> parser` 路由层，不同平台可使用不同抓取/清洗规则，最终都输出统一 `article_raw` 结构。
- 原因：将平台差异收敛在上游，避免污染 `tutoring_info` 解析与查询逻辑。
- 备选方案：在 `tutoring_info` 解析阶段分平台处理。放弃原因是会扩大下游复杂度并增加回归风险。

### 决策 3：后台导入调用 Java 后端任务编排，再复用 crawler 执行能力
- 选择：新增后台导入 API（选择平台 + URL 列表），Java 服务负责校验、入任务、触发执行；执行逻辑复用既有 crawler 任务流程，单次导入上限 10 条。
- 原因：统一审计与状态管理，避免 UI 直接耦合 Python 脚本入口。
- 备选方案：后台直接 SSH/命令触发 CLI。放弃原因是安全性差、可观测性弱、错误处理不一致。

### 决策 4：后台登录采用 DB 预置管理员 + 会话令牌
- 选择：新增管理员表（用户名、密码哈希、状态、最后登录时间等），登录成功后签发 JWT，并通过会话 Cookie 传递；不引入 Redis 做集中式令牌存储。
- 原因：满足“仅登录无注册”的业务要求，兼顾实现复杂度与小系统部署成本。
- 备选方案：使用固定配置文件账号。放弃原因是凭据轮换困难，审计与安全治理不足。

### 决策 5：日志中心采用“文件读取适配层 + 运行端标签”
- 选择：Java 后台提供日志查询接口，聚合 Java 应用日志与 crawler 日志文件；响应中附带 `runtime=java|python` 标签，支持关键字、时间范围、运行端筛选；日志仅支持展示不支持下载。
- 原因：实现成本低、上线快，可直接满足运维查看诉求，并降低下载带来的权限与审计复杂度。
- 备选方案：将 Python 日志同步写入 DB。放弃原因是写入放大明显且会改变现有运行模型。

### 决策 5.1：Java 日志保留策略
- 选择：Java 侧仅采集 Slf4j `INFO/WARN/ERROR` 日志，按天滚动日志文件，后台仅展示近 30 天内容。
- 原因：保留足够运维排障信息，同时控制磁盘占用与日志查询开销。
- 备选方案：长期保留全量日志。放弃原因是存储成本高且后台检索效率下降。

### 决策 6：Java 调 Python 执行策略（本期不引入统一队列）
- 选择：由 Java 使用参数化进程调用触发 Python 命令执行，设置执行超时、并发上限与 stdout/stderr 落日志；本期不引入任务队列中间件。
- 原因：满足当前规模需求，快速交付并控制系统复杂度。
- 备选方案：引入统一任务队列。放弃原因是现阶段收益不足、运维复杂度上升。

### 决策 7：迁移采用“向后兼容字段 + 增量回填”
- 选择：先加字段与表，再升级写入链路；旧数据 `platform_code` 回填默认值（如 `MIAOMIAO_WECHAT`），保证历史查询不受影响。
- 原因：减少停机窗口，降低迁移失败风险。
- 备选方案：一次性全量重构并要求全量重跑。放弃原因是风险高且发布窗口不可控。

## Risks / Trade-offs

- [平台识别错误导致解析器路由错误] -> Mitigation：平台选择由后台显式指定，自动识别仅作为辅助并记录告警。
- [新增平台规则质量不稳定] -> Mitigation：为每个平台建立解析回归样本，变更必须通过平台级测试集。
- [后台日志读取暴露敏感信息] -> Mitigation：日志接口增加脱敏与关键字段过滤，限制最大返回行数与时间窗口。
- [管理员弱口令风险] -> Mitigation：强制密码哈希存储、最小复杂度校验、支持定期轮换。
- [Java 与 Python 协同链路复杂度上升] -> Mitigation：明确任务边界与错误码映射，统一任务状态流转与日志规范。
- [Java 调 Python 存在命令注入与僵尸进程风险] -> Mitigation：仅允许参数化调用、禁止拼接 shell、配置超时与强制回收机制。

## Migration Plan

1. 新增 DDL：平台表、管理员表，扩展 `article_raw`/任务相关表的 `platform_code` 字段与索引。
2. 数据回填：历史 `article_raw` 与任务记录填充默认平台编码，确保旧链路可读。
3. crawler 升级：接入平台路由解析器，验证默认平台路径与新平台路径均可运行。
4. Java 后端升级：新增后台认证、导入与日志查询 API；接入平台主数据查询接口。
5. web 后台页面上线：登录页、导入页、日志页签联调并灰度开放。
6. 运行验证：观察任务成功率、平台分布、日志接口耗时与失败率，确认稳定后全量发布。

回滚策略：
- 后端功能开关关闭后台入口，保留原有采集与查询链路。
- 若平台路由异常，临时回退到默认平台解析器并记录待修复任务。
- 保持新增字段向后兼容，不执行破坏性回滚 DDL。

## Open Questions

- JWT Cookie 的过期时间与刷新策略（固定时长 vs 滑动续期）如何设定？
- Python 进程并发上限与超时时间默认值（如 1 并发、60s/120s）采用哪组参数？
